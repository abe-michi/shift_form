# シフトアプリ 基本設計書 (v1.2)

---

## 1. システム概要

- 小規模〜中規模店舗向けのシフト提出・作成・管理を行うWebアプリ。
- フロントエンド：HTML＋JavaScript（Bootstrap）
- バックエンド：Google Apps Script（GAS）＋スプレッドシート
- シフト提出はWebアプリから、確定・編集は管理者がGAS経由で操作
- シフト表の自動生成・打刻記録・勤怠集計・帳票出力（PDF/CSV）も対応

---

## 2. 対象ユーザー・ロール

| ロール     | 説明               | 主な操作          |
| ------- | ---------------- | ------------- |
| 従業員     | シフト提出、マイページ閲覧    | フォーム入力、実績確認   |
| シフト作成担当 | 提出内容の確認、確定作業、調整  | シフト表編集、仮確定    |
| 管理者     | 全機能操作、ロール管理、帳票出力 | 編集、確定、出力、通知設定 |

※閲覧専用ロールは存在しない。ユーザーごとの機能制御も未対応。

---

## 3. シフト期間・営業日

- 初期設定で「営業日切替時刻」を設定（例：30:00 = 翌6:00）
- 「1日」の定義はこの営業日単位に従う（日付ではなく営業日）
- 深夜・日跨ぎ勤務は営業日単位で1件として記録

---

## 4. 提出・作成・確定ワークフロー

- 従業員がWebフォームから提出（REQUEST）
- シフト作成担当または管理者が確認・編集・確定（CONFIRMED）
- 確定シフトはPDF出力／カレンダー連携／Slack通知が可能

---

## 5. 機能詳細

### 5.1 シフト提出 (S001)

- フォームはスマホ対応（レスポンシブ）で、対象月の日付一覧が並ぶ
- 各日について、勤務パターン選択 → 時刻が自動入力
- 営業日跨ぎを許可する勤務パターンについては、従業員が提出可能
- 営業日跨ぎフラグがtrueのパターンのみ、提出画面上でも跨ぎ時間帯を選択肢として表示
- 提出期限はマスタ設定により指定可能（例：前月20日 23:59）
- 従業員は提出期限内であれば何度でも編集・再提出が可能
- 同一営業日・従業員の提出が複数回あった場合、最新データで上書き（確認ダイアログ表示）
- 管理者は常時編集・提出代行が可能
- 入力バリデーション：開始時刻 < 終了時刻、重複提出は確認表示

---

## 6. 打刻・実績記録

- 打刻は管理者が許可した端末でのみ可（店舗PC or 指定タブレット）
- 退勤時、営業日を跨いでいる場合は即時アラート → 確認＆理由入力必須（設定による）
- 実績時間は営業日単位で集計

---

## 7. 自動割当・ガント表示

- 営業日単位で空き枠に従業員を割り当てるロジック（※詳細設計はv1.1で定義予定）
- 割当対象は営業日内の時間帯に限定（営業日跨ぎ対応済）
- 勤務パターンに制約や優先度などを設ける場合も、v1.1にて仕様策定

---

## 8. 出力・通知・連携

### 8.1 PDF出力

- A4横向き、ロゴ・店舗名・注釈含む。26:00などの表記に対応
- 営業日をまたぐ勤務（例：22:00〜29:00）は、**開始日の営業日欄にまとめて表示**する
- 翌日の欄（7/2など）には表示しない（空欄）
- 表記形式：`22:00〜29:00` のように「翌○時」を26:00〜29:00で表記
- PDFの備考欄またはフッターに以下の注釈を表示：
  > ※「29:00」などの表記は翌営業日の○時に相当します（例：29:00＝翌5:00）

### 8.2 CSV出力

- フォーマット・項目順選択、従業員・日付・状態で絞り込み可能
- 出力時に日付・時刻のフォーマットを選択可（例：`YYYY-MM-DD`, `HH:mm`, `9時〜18時` など）
- 営業日単位での記録・集計に対応

### 8.3 通知（メール／Slack）

- Slack／メール通知：従業員がON/OFF可
- 通知種別（シフト確定、リマインド、変更、退勤漏れ、休暇承認など）を個別設定
- テンプレート編集可能。プレースホルダー対応：`{{氏名}}`, `{{日付}}`, `{{開始}}`, `{{終了}}`, `{{店舗名}}` など
- **管理者通知**：営業日跨ぎ打刻、休暇申請、エラー検出などのイベント通知を受信可能
  - 通知チャネル（Slack／メール）は管理者ごとに選択可
  - ON/OFF設定およびテンプレートカスタマイズにも対応

### 8.4 カレンダー連携（Google Calendar）

- シフトを従業員のGoogleカレンダーに登録可能（提出／確定時）
- カレンダーから空き時間を取得し、希望シフトの提案も可能（OAuth認証必須）
- 双方向連携に対応

---

## 9. セキュリティ・ログ

- アクセス制御：打刻・管理画面へのアクセスは許可端末（店舗PC／店舗タブレット／管理端末）からのみに限定（設定可能）
- セッション：Secure / HttpOnly / SameSite=Lax
- 2段階認証：設定でON/OFF切替可能（メールコード）
- ログ：管理者操作、打刻履歴などをStackdriverへ出力

---

## 10. モバイル対応

- レスポンシブ対応（Bootstrap）
- 打刻・提出UIはスマホに最適化
- PWA対応は将来実装予定（v1.1以降）

---

## 11. 将来拡張候補

- 設定データのインポート／エクスポート対応
  - 対象：勤務パターン、営業日設定、通知設定、出力フォーマットなど
  - 形式：JSON形式でのダウンロード・アップロードに対応
  - 管理画面上でエクスポート／インポート操作が可能
  - インポート時は差分プレビューおよび「全上書き or 項目単位の反映」を選択可

- 外部API／Webhook連携：現時点では対応予定なし。将来的な要望に応じて検討する可能性あり（有償対応含む）

---

（2025-07-10 時点）

---

# 追記・修正項目（v1.1草案）


## バックアップとログ管理（基本設計書への追加）

### 自動バックアップ
- 頻度：毎日1回（時間は設定可能）
- 保存先：Google Drive（初期値：90日間保存）
- 手動ダウンロード対応

### ログ保存
- 保存対象：管理者操作・打刻・提出・エラーなど
- 保存期間：「30日 / 90日 / 無期限 / 任意」を選択可
- 保存方法：スプレッドシート or Stackdriver（Google Cloud Logging）

### 障害対応
- 処理エラー時はメール通知
- 最大3回まで自動リトライ（間隔10分）


---


## 給与計算機能（基本設計書への追加）

### 給与サイクル
- 従業員マスタで「月払い／週払い／日払い」を選択

### 休憩控除
- 6h超：45分、8h超：1h（マスタ設定可能）

### 割増・みなし残業
- 残業倍率やみなし残業をマスタで定義
- 実績に応じて自動計算

### 税・社保
- 現状対象外、将来的に拡張予定


---


## 編集UIとバリデーション（基本設計書への追加）

### 編集UI
- PC：ガントチャートバーのドラッグ
- 全端末：時刻ピッカー
- スマホ：±ボタンで15分単位調整

### バリデーション
| 項目 | 内容 |
|------|------|
| 時刻整合性 | 開始 < 終了のチェック |
| 重複提出 | 上書き確認ダイアログを表示 |
| 営業日跨ぎ | パターン設定による制限 |
| インターバル | 勤務間の最低間隔をチェック（例：11h） |


---


## エラーハンドリング（基本設計書への追加）

### GAS処理の失敗時
- 最大3回リトライ → 失敗時は管理者へメール通知

### フロントエンド側
- 簡潔なエラーメッセージ表示（例：保存に失敗しました）

### ログ出力
- Stackdriverに全エラー記録
- 管理画面から確認可能


---


## 販売・ライセンス管理（基本設計書への追加）

### 販売形態
- 買い切り型（サブスクリプションなし）
- 組織単位（企業・店舗）ごとのライセンスキーを発行

### 認証方式
- 初回インストール時にオンライン認証
- 再認証は再インストール時のみ

### ライセンス管理
- スプレッドシートで管理、再発行や無効化可能
- 同一キー多重使用はアラート通知


---


## 非機能要件（基本設計書への追加）

### パフォーマンス
- 表示速度：2秒以内
- 集計速度：30秒以内

### セキュリティ
- HTTPS通信
- GASの最小権限設定
- セッション：Secure / HttpOnly / SameSite=Lax
- 2段階認証（初期OFF、メールコード方式）

### アクセシビリティ
- キーボード操作・スクリーンリーダー対応
- 色覚補正ON/OFF切替可能

### 多言語・TZ
- 日本語／英語対応（初期は日本語）
- タイムゾーン：日本時間固定（multi-TZは拡張候補）

---

## 3. シフト期間・営業日（修正）

- 初期設定で「営業日切替時刻」を設定（例：30:00 = 翌6:00）
- 「1日」の定義はこの営業日単位に従う（日付ではなく営業日）
- 深夜・日跨ぎ勤務は営業日単位で1件として記録
- **シフト期間単位は「月／半月／週」から選択可能**
- この設定は提出・出力・通知・ガント表示の範囲に反映される

## 5. 機能詳細 > 5.1 シフト提出（追記）

- 提出フォームは期間単位（週／半月／月）ごとに表示される営業日が変化
- 締切はマスタ設定で期間単位ごとに個別指定可（例：週→金曜締切）

## 8. 出力・通知・連携 > ダッシュボード（新設）

- ダッシュボードの集計対象期間は `週／半月／月／四半期` から選択可能
- 指標（実働時間・残業時間・提出率など）を期間別に可視化